#!/bin/bash

EXPORT_FILE_PATH="/home/vagrant/flask_app/exports.sh"

function _start
{
    echo  "starting application...."
    # Run webpack watcher
    cd server/ && npm run watch &
    # Run python server
    python ./run.py &
}

function _unset_envs
{
    bash -c "unset $(cat .env | egrep -o '(^[^#])(\w+?)' | xargs)"
}

function _create_export_file()
{
    env_file_path=$1
    if [ ! $env_file_path ]; then
        echo "please provide the file path to the .env file"
        exit
    fi

    echo "creating an environment export file at $EXPORT_FILE_PATH....."

    if [ -e "$EXPORT_FILE_PATH" ]; then
        # clear content of export file path
        > $EXPORT_FILE_PATH
    fi

    sudo chmod 755 exports.sh >> $EXPORT_FILE_PATH

    # get all non-comment env variables
    cat $file_path | egrep '^[^#]' | awk '{print "export "$1}' >> $EXPORT_FILE_PATH 
}

function _stop
{
    echo  "Stop application...."
    pkill -f "npm|node|python"
}

: '
    NAME

      --  app [start|stop]

    DESCRIPTION
        starts/stops the `webpack` background watch and the python web server.
'

case "$1" in
    start)
        _start
        ;;
    stop)
        _stop
        ;;
    unset_envs)
        _unset_envs
        ;;
    create_export_file)
        _create_export_file $2 
        ;;
    *)
        echo "Usage: app  {start|stop|unset_envs|create_export_file}"
esac
